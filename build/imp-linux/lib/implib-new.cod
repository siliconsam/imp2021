{----------------------------------------------------------------------------}
    !
    ! NEW/DISPOSE routines used to acquire/free heap variables
    ! NEW/DISPOSE routines based on C library malloc/free routines
    !
    ! declare heap access routines
    !
    %external %record(*) %map New ( %name Template )
 0000                      L1000  EQU $
 0000 C8 00 00 01                     ENTER 0000,1

        %external %record(*) %map %spec impmalloc %alias "malloc" ( %integer s )

        %record(*) %name Res
        %integer Bytes = (Size Of(Template)+3) & (\3) {round to longword}
                                      Generating CODE for 'SIZEOF' (MACRO 14)
 0004 8B 45 0C                        MOV EAX,[EBP+12]
 0007 C1 E8 04                        SHR EAX,4
                                      CALL 'SIZEOF' (MACRO 14)
 000A 05 03 00 00 00                  ADD EAX,3
 000F 25 FC FF FF FF                  AND EAX,-4
 0014 89 45 F4                        MOV [EBP-12],EAX

        Res == impmalloc(Bytes)
 0017 FF 75 F4                        PUSH WORD [EBP-12]
 001A E8 5D 00                        CALL 'IMPMALLOC' (EXTERN 93)
 001D 83 C4 04                        ADD ESP,4
 0020 89 45 F8                        MOV [EBP-8],EAX

        %result == Res
 0023 8B 45 F8                        MOV EAX,[EBP-8]
 0026 C9                              LEAVE
 0027 C3                              RET
    %end

{----------------------------------------------------------------------------}
%endoffile
      _TEXT  ENDS
      CONST  SEGMENT WORD PUBLIC 'CONST'
      CONST  ENDS
      _TEXT  SEGMENT WORD PUBLIC 'CODE'
            ENDS
      DATA  SEGMENT WORD PUBLIC 'DATA'
      DATA    ENDS
              ENDS
      _SWTAB  SEGMENT WORD PUBLIC '_SWTAB'
      _SWTAB   ENDS
