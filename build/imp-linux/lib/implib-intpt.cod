{----------------------------------------------------------------------------}
    ! INTPT - return the integer part of a real.  Note that this is
    ! NOT the same as the built-in primitive "INT" which returns the
    ! nearest integer to the real according to IEEE rounding rules.
    ! Thus, INTPT(1.9) = 1, whereas INT(1.9) = 2.  INTPT uses INT
    ! and then adjusts the rounding to truncate.
    %external %integer %function Int Pt(%longreal x)
 0000                      L 1000  EQU $
 0000 C8 00 00 01                     ENTER 0000, 1
        %integer i

        i = int(x)
 0004 DD 45 08                        FLD QWORD [EBP+ 8]
 0007 DB 5D F4                        FISTP [EBP-12]
 000A 8B 45 F4                        MOV EAX,[EBP-12]
 000D 89 45 F8                        MOV [EBP-8],EAX
        %if i # 0 %then %start; ! zero is the easy answer
 0010 8B 45 F8                        MOV EAX,[EBP-8]
 0013 3D 00 00 00 00                  CMP EAX, 0
 0018 74 00                           JE L 1001
            x = x - i
 001A DD 45 08                        FLD QWORD [EBP+ 8]
 001D DB 45 F8                        FILD [EBP-8]
 0020 DE E9                           FSUBP ST( 1),ST
 0022 DD 5D 08                        FSTP QWORD [EBP+ 8]
            %if i > 0 %start; ! correct towards zero - depends which way that is :-)
 0025 8B 45 F8                        MOV EAX,[EBP-8]
 0028 3D 00 00 00 00                  CMP EAX, 0
 002D 7E 00                           JLE L 1002
                %if x < 0 %then i = i - 1
 002F DD 45 08                        FLD QWORD [EBP+ 8]
 0032 D9 EE                           FLDZ
 0034 DE D9                           FCOMPP ST( 1),ST
 0036 DF E0                           FSTSW AX
 0038 9E                              SAHF
 0039 76 00                           JBE L 1003
 003B FF 4D F8                        DEC WORD [EBP-8]
 003E                      L 1003  EQU $
            %else
 003E EB 00                           JMP L 1004
 0040                      L 1002  EQU $
                %if x > 0 %then i = i + 1
 0040 DD 45 08                        FLD QWORD [EBP+ 8]
 0043 D9 EE                           FLDZ
 0045 DE D9                           FCOMPP ST( 1),ST
 0047 DF E0                           FSTSW AX
 0049 9E                              SAHF
 004A 73 00                           JAE L 1005
 004C FF 45 F8                        INC WORD [EBP-8]
 004F                      L 1005  EQU $
            %finish
 004F                      L 1004  EQU $
        %finish
 004F                      L 1001  EQU $
        %result = i
 004F 8B 45 F8                        MOV EAX,[EBP-8]
 0052 C9                              LEAVE
 0053 C3                              RET
    %end

{----------------------------------------------------------------------------}
%endoffile
      _TEXT  ENDS
      CONST  SEGMENT WORD PUBLIC 'CONST'
      CONST  ENDS
      _TEXT  SEGMENT WORD PUBLIC 'CODE'
            ENDS
      DATA  SEGMENT WORD PUBLIC 'DATA'
      DATA    ENDS
              ENDS
      _SWTAB  SEGMENT WORD PUBLIC '_SWTAB'
      _SWTAB   ENDS
